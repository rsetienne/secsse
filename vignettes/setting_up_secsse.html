<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Thijs Janzen" />

<meta name="date" content="2023-06-27" />

<title>Setting up a secsse analysis</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Setting up a secsse analysis</h1>
<h4 class="author">Thijs Janzen</h4>
<h4 class="date">2023-06-27</h4>



<div id="setting-up" class="section level2">
<h2>Setting up</h2>
<p>When preparing a secsse analysis, it can be daunting to prepare the
different required matrices and settings in order to be able to perform
a meaningful analysis. Starting with secsse package version 2.6, there
are now general helper functions available that can prepare all matrices
for some general cases. Often, these general cases can already be
applicable, alternatively, they can be modified later on to better
reflect the intricacies of the specific studied system.</p>
</div>
<div id="requirements-for-secsse-analysis" class="section level2">
<h2>Requirements for secsse analysis</h2>
<p>To perform a secsse analysis, we want to use maximum likelihood to
find the most likely values for our parameters, given a phylogenetic
tree and tip states. To do so, secsse requires the user to specify how
speciation changes the state of the daughter species in relation to the
parent species, and requires the user to specify the number of unique
speciation rates to be fitted. Here, we will explore a basic
example.</p>
<div id="two-observed-states-two-hidden-state" class="section level3">
<h3>Two observed states, two hidden state</h3>
<p>We start with a straightforward, simple case where we have two
observed states (perhaps the presence / absence of an ornament or so),
and we assume that the concealed state follows a similar structure,
e.g. it also has two unique states. Now, we can specify three different
models, 1) constant-rates model, where rates are not dependent on any
trait, 2) Examined-Trait-Diversification (ETD), where rates are
dependent on the observed trait and 3) CTD
(Concealed-Trait-Diversification), where rates are dependent on the
concealed trait.</p>
<div id="lambdas" class="section level4">
<h4>Lambdas</h4>
<p>To create the required lambda-matrices, we need as input information
about the observed state names, the number of concealed states, and a
transition_list object, which is a matrix defining the traits of
daughter species upon speciation and their associated rate. We will here
generate a default transition_list, but the user is free to create (and
encouraged) one manually her/him self in order to reflect the focal
system better. We assume here that we have a trait with lables “S” and
“N”, and use the default settings:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>focal_list <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_default_transition_list</span>(<span class="at">state_names =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>, <span class="st">&quot;N&quot;</span>))</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>focal_list</span></code></pre></div>
<pre><code>##  [,1] [,2] [,3] [,4]
##  &quot;S&quot;  &quot;S&quot;  &quot;S&quot;  &quot;1&quot; 
##  &quot;N&quot;  &quot;N&quot;  &quot;N&quot;  &quot;2&quot;</code></pre>
<p>With this list generated, we can now use this to populate our lambda
matrices, using a constant rates model:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>lambda_matrices <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_lambda_matrices</span>(<span class="at">state_names =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>, <span class="st">&quot;N&quot;</span>),</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>                                                  <span class="at">num_concealed_states =</span> <span class="dv">2</span>, </span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>                                                  <span class="at">transition_list =</span> focal_list,</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>                                                  <span class="at">model =</span> <span class="st">&quot;CR&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>lambda_matrices</span></code></pre></div>
<pre><code>## [[1]]
##    SA NA SB NB
## SA  1  0  0  0
## NA  0  0  0  0
## SB  0  0  0  0
## NB  0  0  0  0
## 
## [[2]]
##    SA NA SB NB
## SA  0  0  0  0
## NA  0  2  0  0
## SB  0  0  0  0
## NB  0  0  0  0
## 
## [[3]]
##    SA NA SB NB
## SA  0  0  0  0
## NA  0  0  0  0
## SB  0  0  1  0
## NB  0  0  0  0
## 
## [[4]]
##    SA NA SB NB
## SA  0  0  0  0
## NA  0  0  0  0
## SB  0  0  0  0
## NB  0  0  0  2</code></pre>
<p>We see that there are four lambda matrices, one for each of the
combined states (e.g. for each combination of observed and hidden
states). So in this case we have our two observed states S and N, and
the two hidden states A and B. This results in the four real states SA,
NA, SB and NB.</p>
</div>
<div id="extinction" class="section level4">
<h4>Extinction</h4>
<p>We also need to specify an extinction rate:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>mus <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_mus</span>(<span class="at">state_names =</span> <span class="fu">colnames</span>(lambda_matrices[[<span class="dv">1</span>]]),</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>                          <span class="at">num_concealed_states =</span> <span class="dv">2</span>,</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>                          <span class="at">model =</span> <span class="st">&quot;CR&quot;</span>,</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>                          <span class="at">lambdas =</span> lambda_matrices)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>mus</span></code></pre></div>
<pre><code>## SA NA SB NB 
##  3  3  3  3</code></pre>
</div>
<div id="q-matrix" class="section level4">
<h4>Q matrix</h4>
<p>To specify a q-matrix, we again need to specify the transitions using
a transition list. Again, we use the standard settings.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>q_list <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_default_q_list</span>(<span class="at">state_names =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>, <span class="st">&quot;N&quot;</span>),</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>                                        <span class="at">num_concealed_states =</span> <span class="dv">2</span>,</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>                                        <span class="at">mus =</span> mus)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>q_list</span></code></pre></div>
<pre><code>##  [,1] [,2] [,3]
##  &quot;SA&quot; &quot;NA&quot; &quot;4&quot; 
##  &quot;SB&quot; &quot;NB&quot; &quot;4&quot; 
##  &quot;NA&quot; &quot;SA&quot; &quot;5&quot; 
##  &quot;NB&quot; &quot;SB&quot; &quot;5&quot; 
##  &quot;SA&quot; &quot;SB&quot; &quot;6&quot; 
##  &quot;NA&quot; &quot;NB&quot; &quot;6&quot; 
##  &quot;SB&quot; &quot;SA&quot; &quot;7&quot; 
##  &quot;NB&quot; &quot;NA&quot; &quot;7&quot;</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>trans_matrix <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_transition_matrix</span>(<span class="at">state_names =</span> <span class="fu">colnames</span>(lambda_matrices[[<span class="dv">1</span>]]),</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>                                                 <span class="at">transition_list =</span> q_list)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>trans_matrix</span></code></pre></div>
<pre><code>##    SA NA SB NB
## SA NA  4  6  0
## NA  5 NA  0  6
## SB  7  0 NA  4
## NB  0  7  5 NA</code></pre>
<p>Here, we find transitions from A-&gt;B, B-&gt;A but also S-&gt;N and
N-&gt;S.</p>
</div>
</div>
<div id="simulating-data" class="section level3">
<h3>Simulating data</h3>
<p>Now, we can use our settings to perform an analysis. Because we are
lacking empirical data in this example, we will simulate a tree for
this. To do so, we first need to specify our focal rates, and then fill
them in.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>speciation_S <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>speciation_N <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>extinction <span class="ot">&lt;-</span> <span class="fl">0.0</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>q_ab <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>q_ba <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>sp_ns <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>sp_sn <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(speciation_S, </span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>            speciation_N,</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>            extinction, </span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>            sp_ns, sp_sn, q_ab, q_ba)</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>lambda_matrices_p <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">fill_in</span>(lambda_matrices,</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>                                     params)</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>trans_matrix_p <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">fill_in</span>(trans_matrix,</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>                                  params)</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>mus_p <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">fill_in</span>(mus,</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>                         params)</span></code></pre></div>
<p>With the values replaced, we can now simulate an “empirical”
dataset:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>simulated_tree <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">secsse_sim</span>(<span class="at">lambdas =</span> lambda_matrices_p,</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>                                     <span class="at">mus =</span> mus_p,</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>                                     <span class="at">qs =</span> trans_matrix_p,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>                                     <span class="at">num_concealed_states =</span> <span class="dv">2</span>,</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>                                     <span class="at">crown_age =</span> <span class="dv">5</span>,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>                                     <span class="at">conditioning =</span> <span class="st">&quot;obs_states&quot;</span>,</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>                                     <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>sim_traits <span class="ot">&lt;-</span> simulated_tree<span class="sc">$</span>obs_traits</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>focal_tree <span class="ot">&lt;-</span> simulated_tree<span class="sc">$</span>phy</span></code></pre></div>
</div>
<div id="maximum-likelihood" class="section level3">
<h3>Maximum Likelihood</h3>
<p>Given this data, we can now perform our maximum likelihood analysis.
Here, we choose to initialize our parameters with random values in [0,
1], we use multithreading to speed up the analysis, and use the subplex
optimization method, as this has shown to be more reliable.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>param_posit <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>param_posit[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> lambda_matrices</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>param_posit[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> mus</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>param_posit[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> trans_matrix</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>initpars <span class="ot">&lt;-</span> params</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>initpars[initpars <span class="sc">==</span> <span class="fl">0.0</span>] <span class="ot">&lt;-</span> <span class="fl">1e-5</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>answ <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">cla_secsse_ml</span>(<span class="at">phy =</span> focal_tree,</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>                              <span class="at">traits =</span> sim_traits,</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>                              <span class="at">num_concealed_states =</span> <span class="dv">2</span>,</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>                              <span class="at">idparslist =</span> param_posit,</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>                              <span class="at">idparsopt =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>),</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>                              <span class="at">initparsopt =</span> initpars,</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>                              <span class="at">idparsfix =</span> <span class="fu">c</span>(<span class="dv">0</span>),</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>                              <span class="at">parsfix =</span> <span class="fu">c</span>(<span class="fl">0.0</span>),</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>                              <span class="at">sampling_fraction =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>                              <span class="at">optimmethod =</span> <span class="st">&quot;subplex&quot;</span>,</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>                              <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>                              <span class="at">num_threads =</span> <span class="dv">6</span>)</span></code></pre></div>
<pre><code>## Note: you set some transitions as impossible to happen. 
## Calculating the likelihood for the initial parameters ... 
## The loglikelihood for the initial parameter values is -74.35462 
## Optimizing the likelihood - this may take a while.</code></pre>
<p>We can now extract our parameters to get them in the right place:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>found_pars_vals <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">extract_par_vals</span>(param_posit, answ<span class="sc">$</span>MLpars)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>found_pars_vals</span></code></pre></div>
<pre><code>## [1] 7.028296e-01 6.960916e-01 5.560552e-07 3.184036e-01 1.533657e-01
## [6] 3.953418e-01 5.374040e-01</code></pre>
</div>
</div>
<div id="comparing-models-using-aic" class="section level2">
<h2>Comparing models using AIC</h2>
<p>We have done this now only for the CR model, but we can also use the
CTD and ETD model. Let’s do that semi-automagically! We first define a
generic function to optimize for a model:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>fit_model <span class="ot">&lt;-</span> <span class="cf">function</span>(tree, traits, model) {</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>  focal_list <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_default_transition_list</span>(<span class="at">state_names =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>, <span class="st">&quot;N&quot;</span>))</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  lambda_matrices <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_lambda_matrices</span>(<span class="at">state_names =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>, <span class="st">&quot;N&quot;</span>),</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>                                                    <span class="at">num_concealed_states =</span> <span class="dv">2</span>, </span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>                                                    <span class="at">transition_list =</span> focal_list,</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>                                                    <span class="at">model =</span> model)</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>  mus <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_mus</span>(<span class="at">state_names =</span> <span class="fu">colnames</span>(trans_matrix),</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>                            <span class="at">num_concealed_states =</span> <span class="dv">2</span>,</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>                            <span class="at">model =</span> model,</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>                            <span class="at">lambdas =</span> lambda_matrices)</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  q_list <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_default_q_list</span>(<span class="at">state_names =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>, <span class="st">&quot;N&quot;</span>),</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>                                          <span class="at">num_concealed_states =</span> <span class="dv">2</span>,</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>                                          <span class="at">mus =</span> mus)</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>  </span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>  trans_matrix <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">create_transition_matrix</span>(<span class="at">state_names =</span> </span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>                                                     <span class="fu">colnames</span>(lambda_matrices[[<span class="dv">1</span>]]),</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>                                                   <span class="at">transition_list =</span> q_list)</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>  </span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>  param_posit <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>  param_posit[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> lambda_matrices</span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a>  param_posit[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> mus</span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>  param_posit[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> trans_matrix</span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>  </span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a>  max_indicator <span class="ot">&lt;-</span> <span class="fu">max</span>(trans_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>  </span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a>  <span class="co"># we cheat a bit by setting extinction to zero -</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a>  <span class="co"># in a real analysis this should be avoided.</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a>  extinct_rates <span class="ot">&lt;-</span> <span class="fu">unique</span>(mus)</span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a>  idparsopt <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>max_indicator</span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a>  idparsopt <span class="ot">&lt;-</span> idparsopt[<span class="sc">-</span>extinct_rates]</span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a>  idparsfix <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, extinct_rates)</span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a>  parsfix <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.0</span>, <span class="fu">length</span>(idparsfix))</span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a>  </span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a>  initpars <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="fu">length</span>(idparsopt))</span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_output</span>( <span class="co"># suppress output</span></span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a>  answ <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">cla_secsse_ml</span>(<span class="at">phy =</span> focal_tree,</span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a>                                <span class="at">traits =</span> traits,</span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a>                                <span class="at">num_concealed_states =</span> <span class="dv">2</span>,</span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a>                                <span class="at">idparslist =</span> param_posit,</span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a>                                <span class="at">idparsopt =</span> idparsopt,</span>
<span id="cb17-42"><a href="#cb17-42" tabindex="-1"></a>                                <span class="at">initparsopt =</span> initpars,</span>
<span id="cb17-43"><a href="#cb17-43" tabindex="-1"></a>                                <span class="at">idparsfix =</span> idparsfix,</span>
<span id="cb17-44"><a href="#cb17-44" tabindex="-1"></a>                                <span class="at">parsfix =</span> parsfix,</span>
<span id="cb17-45"><a href="#cb17-45" tabindex="-1"></a>                                <span class="at">sampling_fraction =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb17-46"><a href="#cb17-46" tabindex="-1"></a>                                <span class="at">optimmethod =</span> <span class="st">&quot;subplex&quot;</span>,</span>
<span id="cb17-47"><a href="#cb17-47" tabindex="-1"></a>                                <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-48"><a href="#cb17-48" tabindex="-1"></a>                                <span class="at">num_threads =</span> <span class="dv">6</span>)</span>
<span id="cb17-49"><a href="#cb17-49" tabindex="-1"></a>  )</span>
<span id="cb17-50"><a href="#cb17-50" tabindex="-1"></a>  found_pars_vals <span class="ot">&lt;-</span> secsse<span class="sc">::</span><span class="fu">extract_par_vals</span>(param_posit, answ<span class="sc">$</span>MLpars)</span>
<span id="cb17-51"><a href="#cb17-51" tabindex="-1"></a>  aic <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> max_indicator <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">as.numeric</span>(answ<span class="sc">$</span>ML)</span>
<span id="cb17-52"><a href="#cb17-52" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">pars =</span> found_pars_vals,</span>
<span id="cb17-53"><a href="#cb17-53" tabindex="-1"></a>              <span class="at">ml =</span> <span class="fu">as.numeric</span>(answ<span class="sc">$</span>ML),</span>
<span id="cb17-54"><a href="#cb17-54" tabindex="-1"></a>              <span class="at">aic =</span> aic))</span>
<span id="cb17-55"><a href="#cb17-55" tabindex="-1"></a>}</span></code></pre></div>
<p>And then we loop over the different models:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>found <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="cf">for</span> (focal_model <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;CR&quot;</span>, <span class="st">&quot;CTD&quot;</span>, <span class="st">&quot;ETD&quot;</span>)) {</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  local_answ <span class="ot">&lt;-</span> <span class="fu">fit_model</span>(<span class="at">tree =</span> focal_tree, </span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>                          <span class="at">traits =</span> sim_traits,</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>                          <span class="at">model =</span> focal_model)</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>  to_add <span class="ot">&lt;-</span> <span class="fu">c</span>(focal_model, local_answ<span class="sc">$</span>ml, local_answ<span class="sc">$</span>aic)</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>  found <span class="ot">&lt;-</span> <span class="fu">rbind</span>(found, to_add)</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>}</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="fu">colnames</span>(found) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;model&quot;</span>, <span class="st">&quot;LL&quot;</span>, <span class="st">&quot;AIC&quot;</span>)</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>found <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(found)</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>found<span class="sc">$</span>LL <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(found<span class="sc">$</span>LL)</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>found<span class="sc">$</span>AIC <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(found<span class="sc">$</span>AIC)</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>found </span></code></pre></div>
<pre><code>##          model        LL      AIC
## to_add      CR -66.78108 147.5622
## to_add.1   CTD -66.02864 148.0573
## to_add.2   ETD -66.78108 149.5622</code></pre>
<p>Because we have simulated the tree using the CR model, we expect the
model with the lowest AIC to be the CR model again, and indeed we do
find this!</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
