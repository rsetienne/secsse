<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="secsse">
<title>Setting up a secsse analysis • secsse</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Setting up a secsse analysis">
<meta property="og:description" content="secsse">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">secsse</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.6.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Using_secsse.html">Using SecSSE ML search</a>
    <a class="dropdown-item" href="../articles/plotting_states.html">Plotting probabilities</a>
    <a class="dropdown-item" href="../articles/setting_up_secsse.html">Setting up a secsse analysis</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rsetienne/secsse/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Setting up a secsse analysis</h1>
                        <h4 data-toc-skip class="author">Thijs
Janzen</h4>
            
            <h4 data-toc-skip class="date">2023-07-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rsetienne/secsse/blob/HEAD/vignettes/setting_up_secsse.Rmd" class="external-link"><code>vignettes/setting_up_secsse.Rmd</code></a></small>
      <div class="d-none name"><code>setting_up_secsse.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="setting-up">Setting up<a class="anchor" aria-label="anchor" href="#setting-up"></a>
</h2>
<p>When preparing a secsse analysis, it can be daunting to prepare the
different required matrices and settings in order to be able to perform
a meaningful analysis. Starting with secsse package version 2.6, there
are now general helper functions available that can prepare all matrices
for some general cases. Often, these general cases can already be
applicable, alternatively, they can be modified later on to better
reflect the intricacies of the specific studied system.</p>
</div>
<div class="section level2">
<h2 id="requirements-for-secsse-analysis">Requirements for secsse analysis<a class="anchor" aria-label="anchor" href="#requirements-for-secsse-analysis"></a>
</h2>
<p>To perform a secsse analysis, we want to use maximum likelihood to
find the most likely values for our parameters, given a phylogenetic
tree and tip states. To do so, secsse requires the user to specify how
speciation changes the state of the daughter species in relation to the
parent species, and requires the user to specify the number of unique
speciation rates to be fitted. Here, we will explore a basic
example.</p>
<div class="section level3">
<h3 id="two-observed-states-two-hidden-state">Two observed states, two hidden state<a class="anchor" aria-label="anchor" href="#two-observed-states-two-hidden-state"></a>
</h3>
<p>We start with a straightforward, simple case where we have two
observed states (perhaps the presence / absence of an ornament or so),
and we assume that the concealed state follows a similar structure,
e.g. it also has two unique states. Now, we can specify three different
models, 1) constant-rates model, where rates are not dependent on any
trait, 2) Examined-Trait-Diversification (ETD), where rates are
dependent on the observed trait and 3) CTD
(Concealed-Trait-Diversification), where rates are dependent on the
concealed trait.</p>
<div class="section level4">
<h4 id="lambdas">Lambdas<a class="anchor" aria-label="anchor" href="#lambdas"></a>
</h4>
<p>To create the required lambda-matrices, we need as input information
about the observed state names, the number of concealed states, and a
transition_list object, which is a matrix defining the traits of
daughter species upon speciation and their associated rate. We will here
generate a default transition_list, but the user is free to create (and
encouraged) one manually her/him self in order to reflect the focal
system better. We assume here that we have a trait with labels “S” and
“N”, and use the default settings:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">used_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"N"</span><span class="op">)</span></span>
<span><span class="va">focal_list</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_default_lambda_list.html">create_default_lambda_list</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                                                 model <span class="op">=</span> <span class="st">"CR"</span><span class="op">)</span></span>
<span><span class="va">focal_list</span></span></code></pre></div>
<pre><code><span><span class="co">##  [,1] [,2] [,3] [,4]</span></span>
<span><span class="co">##  "S"  "S"  "S"  "1" </span></span>
<span><span class="co">##  "N"  "N"  "N"  "1"</span></span></code></pre>
<p>With this list generated, we can now use this to populate our lambda
matrices, using a constant rates model and assuming two concealed states
(the same number as our observed states):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_hidden_states</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">lambda_matrices</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_lambda_matrices.html">create_lambda_matrices</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                                                  num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                                                  transition_list <span class="op">=</span> <span class="va">focal_list</span>,</span>
<span>                                                  model <span class="op">=</span> <span class="st">"CR"</span><span class="op">)</span></span>
<span><span class="va">lambda_matrices</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">##    SA NA SB NB</span></span>
<span><span class="co">## SA  1  0  0  0</span></span>
<span><span class="co">## NA  0  0  0  0</span></span>
<span><span class="co">## SB  0  0  0  0</span></span>
<span><span class="co">## NB  0  0  0  0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">##    SA NA SB NB</span></span>
<span><span class="co">## SA  0  0  0  0</span></span>
<span><span class="co">## NA  0  1  0  0</span></span>
<span><span class="co">## SB  0  0  0  0</span></span>
<span><span class="co">## NB  0  0  0  0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">##    SA NA SB NB</span></span>
<span><span class="co">## SA  0  0  0  0</span></span>
<span><span class="co">## NA  0  0  0  0</span></span>
<span><span class="co">## SB  0  0  1  0</span></span>
<span><span class="co">## NB  0  0  0  0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">##    SA NA SB NB</span></span>
<span><span class="co">## SA  0  0  0  0</span></span>
<span><span class="co">## NA  0  0  0  0</span></span>
<span><span class="co">## SB  0  0  0  0</span></span>
<span><span class="co">## NB  0  0  0  1</span></span></code></pre>
<p>We see that there are four lambda matrices, one for each of the
combined states (e.g. for each combination of observed and hidden
states). So in this case we have our two observed states S and N, and
the two hidden states A and B. This results in the four real states SA,
NA, SB and NB.</p>
</div>
<div class="section level4">
<h4 id="extinction">Extinction<a class="anchor" aria-label="anchor" href="#extinction"></a>
</h4>
<p>We also need to specify an extinction rate:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mus</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_mus.html">create_mus</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                          num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                          model <span class="op">=</span> <span class="st">"CR"</span>,</span>
<span>                          lambdas <span class="op">=</span> <span class="va">lambda_matrices</span><span class="op">)</span></span>
<span><span class="va">mus</span></span></code></pre></div>
<pre><code><span><span class="co">## SA NA SB NB </span></span>
<span><span class="co">##  2  2  2  2</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="q-matrix">Q matrix<a class="anchor" aria-label="anchor" href="#q-matrix"></a>
</h4>
<p>To specify a q-matrix, we again need to specify the transitions using
a transition list. Again, we use the standard settings.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q_list</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_default_q_list.html">create_default_q_list</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                                        num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                                        mus <span class="op">=</span> <span class="va">mus</span><span class="op">)</span></span>
<span></span>
<span><span class="va">q_list</span></span></code></pre></div>
<pre><code><span><span class="co">##  [,1] [,2] [,3]</span></span>
<span><span class="co">##  "S"  "N"  "3" </span></span>
<span><span class="co">##  "N"  "S"  "4"</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trans_matrix</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_transition_matrix.html">create_transition_matrix</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                                                 num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                                                 transition_list <span class="op">=</span> <span class="va">q_list</span>,</span>
<span>                                                 diff.conceal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">trans_matrix</span></span></code></pre></div>
<pre><code><span><span class="co">##    SA NA SB NB</span></span>
<span><span class="co">## SA NA  3  5  0</span></span>
<span><span class="co">## NA  4 NA  0  5</span></span>
<span><span class="co">## SB  6  0 NA  3</span></span>
<span><span class="co">## NB  0  6  4 NA</span></span></code></pre>
<p>Here, we find transitions from A-&gt;B, B-&gt;A but also S-&gt;N and
N-&gt;S.</p>
</div>
</div>
<div class="section level3">
<h3 id="simulating-data">Simulating data<a class="anchor" aria-label="anchor" href="#simulating-data"></a>
</h3>
<p>Now, we can use our settings to perform an analysis. Because we are
lacking empirical data in this example, we will simulate a tree for
this. To do so, we first need to specify our focal rates, and then fill
them in.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">speciation</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">extinction</span> <span class="op">&lt;-</span> <span class="fl">0.0</span></span>
<span><span class="va">sp_sn</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">sp_ns</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">q_ab</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">q_ba</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">speciation</span>,</span>
<span>            <span class="va">extinction</span>,</span>
<span>            <span class="va">sp_sn</span>, <span class="va">sp_ns</span>,</span>
<span>            <span class="va">q_ab</span>, <span class="va">q_ba</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lambda_matrices_p</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/fill_in.html">fill_in</a></span><span class="op">(</span><span class="va">lambda_matrices</span>,</span>
<span>                                     <span class="va">params</span><span class="op">)</span></span>
<span><span class="va">trans_matrix_p</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/fill_in.html">fill_in</a></span><span class="op">(</span><span class="va">trans_matrix</span>,</span>
<span>                                  <span class="va">params</span><span class="op">)</span></span>
<span><span class="va">mus_p</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/fill_in.html">fill_in</a></span><span class="op">(</span><span class="va">mus</span>,</span>
<span>                         <span class="va">params</span><span class="op">)</span></span></code></pre></div>
<p>With the values replaced, we can now simulate an “empirical”
dataset:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulated_tree</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/secsse_sim.html">secsse_sim</a></span><span class="op">(</span>lambdas <span class="op">=</span> <span class="va">lambda_matrices_p</span>,</span>
<span>                                     mus <span class="op">=</span> <span class="va">mus_p</span>,</span>
<span>                                     qs <span class="op">=</span> <span class="va">trans_matrix_p</span>,</span>
<span>                                     num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                                     crown_age <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                     conditioning <span class="op">=</span> <span class="st">"obs_states"</span>,</span>
<span>                                     verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                     seed <span class="op">=</span> <span class="fl">26</span><span class="op">)</span></span>
<span><span class="va">sim_traits</span> <span class="op">&lt;-</span> <span class="va">simulated_tree</span><span class="op">$</span><span class="va">obs_traits</span></span>
<span><span class="va">focal_tree</span> <span class="op">&lt;-</span> <span class="va">simulated_tree</span><span class="op">$</span><span class="va">phy</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="maximum-likelihood">Maximum Likelihood<a class="anchor" aria-label="anchor" href="#maximum-likelihood"></a>
</h3>
<p>Given this data, we can now perform our maximum likelihood analysis.
Here, we choose to initialize our parameters with random values in [0,
1], we use multithreading to speed up the analysis, and use the subplex
optimization method, as this has shown to be more reliable.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">param_posit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">param_posit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lambda_matrices</span></span>
<span><span class="va">param_posit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mus</span></span>
<span><span class="va">param_posit</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">trans_matrix</span></span>
<span></span>
<span><span class="va">initpars</span> <span class="op">&lt;-</span> <span class="va">params</span></span>
<span><span class="va">initpars</span> <span class="op">&lt;-</span> <span class="va">initpars</span><span class="op">[</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">answ</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/cla_secsse_ml.html">cla_secsse_ml</a></span><span class="op">(</span>phy <span class="op">=</span> <span class="va">focal_tree</span>,</span>
<span>                              traits <span class="op">=</span> <span class="va">sim_traits</span>,</span>
<span>                              num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                              idparslist <span class="op">=</span> <span class="va">param_posit</span>,</span>
<span>                              idparsopt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>                              initparsopt <span class="op">=</span> <span class="va">initpars</span>,</span>
<span>                              idparsfix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                              parsfix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">0.0</span><span class="op">)</span>,</span>
<span>                              sampling_fraction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                              optimmethod <span class="op">=</span> <span class="st">"subplex"</span>,</span>
<span>                              verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                              num_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>                              atol <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># high values for demonstration </span></span>
<span>                              rtol <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="co"># purposes, don't use at home!</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in secsse::cla_secsse_ml(phy = focal_tree, traits = sim_traits, : Note:</span></span>
<span><span class="co">## you set some transitions as impossible to happen.</span></span></code></pre>
<p>We can now extract our parameters to get them in the right place:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">found_pars_vals</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_par_vals.html">extract_par_vals</a></span><span class="op">(</span><span class="va">param_posit</span>, <span class="va">answ</span><span class="op">$</span><span class="va">MLpars</span><span class="op">)</span></span>
<span><span class="va">found_pars_vals</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.6105440 0.0000000 0.1472390 0.1314893 0.2108830 0.8234399</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="comparing-models-using-aic">Comparing models using AIC<a class="anchor" aria-label="anchor" href="#comparing-models-using-aic"></a>
</h2>
<p>We have done this now only for the CR model, but we can also use the
CTD and ETD model. Let’s do that semi-automagically! We first define a
generic function to optimize for a model:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">focal_tree</span>, <span class="va">traits</span>, <span class="va">model</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">focal_list</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_default_lambda_list.html">create_default_lambda_list</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                                                   model <span class="op">=</span> <span class="va">model</span><span class="op">)</span></span>
<span>  <span class="va">lambda_matrices</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_lambda_matrices.html">create_lambda_matrices</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                                                    num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                                                    transition_list <span class="op">=</span></span>
<span>                                                        <span class="va">focal_list</span>,</span>
<span>                                                    model <span class="op">=</span> <span class="va">model</span><span class="op">)</span></span>
<span>  <span class="va">mus</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_mus.html">create_mus</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                            num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                            model <span class="op">=</span> <span class="va">model</span>,</span>
<span>                            lambdas <span class="op">=</span> <span class="va">lambda_matrices</span><span class="op">)</span></span>
<span>  <span class="va">q_list</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_default_q_list.html">create_default_q_list</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                                          num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                                          mus <span class="op">=</span> <span class="va">mus</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">trans_matrix</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/create_transition_matrix.html">create_transition_matrix</a></span><span class="op">(</span>state_names <span class="op">=</span> <span class="va">used_states</span>,</span>
<span>                                                   num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                                                   transition_list <span class="op">=</span> <span class="va">q_list</span>,</span>
<span>                                                   diff.conceal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">param_posit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">param_posit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lambda_matrices</span></span>
<span>  <span class="va">param_posit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mus</span></span>
<span>  <span class="va">param_posit</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">trans_matrix</span></span>
<span></span>
<span>  <span class="va">max_indicator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">trans_matrix</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># we cheat a bit by setting extinction to zero -</span></span>
<span>  <span class="co"># in a real analysis this should be avoided.</span></span>
<span>  <span class="va">extinct_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">mus</span><span class="op">)</span></span>
<span>  <span class="va">idparsopt</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">max_indicator</span></span>
<span>  <span class="va">idparsopt</span> <span class="op">&lt;-</span> <span class="va">idparsopt</span><span class="op">[</span><span class="op">-</span><span class="va">extinct_rates</span><span class="op">]</span></span>
<span>  <span class="va">idparsfix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">extinct_rates</span><span class="op">)</span></span>
<span>  <span class="va">parsfix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">idparsfix</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">initpars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">params</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">extinct_rates</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                <span class="va">params</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">answ</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/cla_secsse_ml.html">cla_secsse_ml</a></span><span class="op">(</span>phy <span class="op">=</span> <span class="va">focal_tree</span>,</span>
<span>                                traits <span class="op">=</span> <span class="va">traits</span>,</span>
<span>                                num_concealed_states <span class="op">=</span> <span class="va">num_hidden_states</span>,</span>
<span>                                idparslist <span class="op">=</span> <span class="va">param_posit</span>,</span>
<span>                                idparsopt <span class="op">=</span> <span class="va">idparsopt</span>,</span>
<span>                                initparsopt <span class="op">=</span> <span class="va">initpars</span>,</span>
<span>                                idparsfix <span class="op">=</span> <span class="va">idparsfix</span>,</span>
<span>                                parsfix <span class="op">=</span> <span class="va">parsfix</span>,</span>
<span>                                sampling_fraction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                optimmethod <span class="op">=</span> <span class="st">"subplex"</span>,</span>
<span>                                verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                num_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>                                atol <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># high values for demonstration </span></span>
<span>                                rtol <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="co"># purposes, don't use at home!</span></span>
<span>  <span class="va">found_pars_vals</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_par_vals.html">extract_par_vals</a></span><span class="op">(</span><span class="va">param_posit</span>, <span class="va">answ</span><span class="op">$</span><span class="va">MLpars</span><span class="op">)</span></span>
<span>  <span class="va">aic</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">max_indicator</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">answ</span><span class="op">$</span><span class="va">ML</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pars <span class="op">=</span> <span class="va">found_pars_vals</span>,</span>
<span>              ml <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">answ</span><span class="op">$</span><span class="va">ML</span><span class="op">)</span>,</span>
<span>              aic <span class="op">=</span> <span class="va">aic</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And then we can loop over the different models:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">found</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">focal_model</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CR"</span>, <span class="st">"CTD"</span>, <span class="st">"ETD"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">local_answ</span> <span class="op">&lt;-</span> <span class="fu">fit_model</span><span class="op">(</span>focal_tree <span class="op">=</span> <span class="va">focal_tree</span>,</span>
<span>                          traits <span class="op">=</span> <span class="va">sim_traits</span>,</span>
<span>                          model <span class="op">=</span> <span class="va">focal_model</span><span class="op">)</span></span>
<span>  <span class="va">found</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">found</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">focal_model</span>, <span class="va">local_answ</span><span class="op">$</span><span class="va">ml</span>, <span class="va">local_answ</span><span class="op">$</span><span class="va">aic</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in secsse::cla_secsse_ml(phy = focal_tree, traits = traits,</span></span>
<span><span class="co">## num_concealed_states = num_hidden_states, : Note: you set some transitions as</span></span>
<span><span class="co">## impossible to happen.</span></span>
<span></span>
<span><span class="co">## Warning in secsse::cla_secsse_ml(phy = focal_tree, traits = traits,</span></span>
<span><span class="co">## num_concealed_states = num_hidden_states, : Note: you set some transitions as</span></span>
<span><span class="co">## impossible to happen.</span></span>
<span></span>
<span><span class="co">## Warning in secsse::cla_secsse_ml(phy = focal_tree, traits = traits,</span></span>
<span><span class="co">## num_concealed_states = num_hidden_states, : Note: you set some transitions as</span></span>
<span><span class="co">## impossible to happen.</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">found</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">"LL"</span>, <span class="st">"AIC"</span><span class="op">)</span></span>
<span><span class="va">found</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">found</span><span class="op">)</span></span>
<span><span class="va">found</span><span class="op">$</span><span class="va">LL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">found</span><span class="op">$</span><span class="va">LL</span><span class="op">)</span></span>
<span><span class="va">found</span><span class="op">$</span><span class="va">AIC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">found</span><span class="op">$</span><span class="va">AIC</span><span class="op">)</span></span>
<span><span class="va">found</span></span></code></pre></div>
<pre><code><span><span class="co">##   model        LL      AIC</span></span>
<span><span class="co">## 1    CR -128.1962 268.3923</span></span>
<span><span class="co">## 2   CTD -127.8295 271.6590</span></span>
<span><span class="co">## 3   ETD -127.9006 271.8012</span></span></code></pre>
<p>Because we have simulated the tree using the CR model, we expect the
model with the lowest AIC to be the CR model again, and indeed we do
find this!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Leonel Herrera Alsina, Paul van Els, Rampal S. Etienne.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
