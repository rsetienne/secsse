<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Secsse performance • secsse</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Secsse performance">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">secsse</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">3.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/starting_secsse.html">Starting secsse</a></li>
    <li><a class="dropdown-item" href="../articles/plotting_states.html">Plotting probabilities</a></li>
    <li><a class="dropdown-item" href="../articles/sim_with_secsse.html">Simulating with secsse</a></li>
    <li><a class="dropdown-item" href="../articles/complete_tree.html">Using secsse with complete phylogenies (with extinction)</a></li>
    <li><a class="dropdown-item" href="../articles/secsse_performance.html">Secsse performance</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rsetienne/secsse/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Secsse performance</h1>
                        <h4 data-toc-skip class="author">Thijs
Janzen</h4>
            
            <h4 data-toc-skip class="date">2023-07-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rsetienne/secsse/blob/master/vignettes/secsse_performance.Rmd" class="external-link"><code>vignettes/secsse_performance.Rmd</code></a></small>
      <div class="d-none name"><code>secsse_performance.Rmd</code></div>
    </div>

    
    
<p>secsse has gone over many versions since it’s first appearance on
CRAN in 2019, with various rates of computational performance. Here, we
would like to shortly go over the main versions of secsse, and compare
their computational performance.</p>
<div class="section level2">
<h2 id="secsse-versions">Secsse Versions<a class="anchor" aria-label="anchor" href="#secsse-versions"></a>
</h2>
<div class="section level3">
<h3 id="section">1.0.0<a class="anchor" aria-label="anchor" href="#section"></a>
</h3>
<p>The first version of secsse appeared in January of 2019 on CRAN. It
used the package deSolve to solve all integrations, and could switch
between either using a fully R based evaluation, or use FORTRAN to speed
up calculations. Furthermore, using the foreach package, within-R
parallelization was implemented. However, parallelization only
situationally improved computation times, and generally, computation was
relatively slow.</p>
</div>
<div class="section level3">
<h3 id="section-1">2.0.0<a class="anchor" aria-label="anchor" href="#section-1"></a>
</h3>
<p>Version 2.0.0 appeared in June of 2019 on CRAN and extended the
package with the cla framework, e.g. including state shifts during
speciation / asymmetric inheritance during speciation.</p>
</div>
<div class="section level3">
<h3 id="section-2">2.5.0<a class="anchor" aria-label="anchor" href="#section-2"></a>
</h3>
<p>Version 2.5.0 appeared in 2021 on GitHub and was published in May
2023 on CRAN. Version 2.5.0 marks the first version using C++ to perform
the integration, and it used tbb (from the RcppParallel package) to
perform multithreading. This marks a ten fold increase in speed over
previous versions.</p>
</div>
<div class="section level3">
<h3 id="section-3">2.6.0<a class="anchor" aria-label="anchor" href="#section-3"></a>
</h3>
<p>Version 2.6.0 appeared on CRAN in July 2023, and introduced many
functions suited to prepare the parameter structure for secsse. It also
introduced a new C++ code base for the standard likelihood, making
smarter use of parallelization, this marks another 10-fold increase in
speed.</p>
</div>
<div class="section level3">
<h3 id="section-4">3.0.0<a class="anchor" aria-label="anchor" href="#section-4"></a>
</h3>
<p>Version 3.0.0 is expected to arrive to CRAN in the second half of
2023. It extends the C++ code base used for the standard likelihood to
the cla likelihood, harnessing the same computation improvement.</p>
</div>
</div>
<div class="section level2">
<h2 id="speed">Speed<a class="anchor" aria-label="anchor" href="#speed"></a>
</h2>
<p>Using a standardized computation test of calculating the likelihood
of a system with two observed and two concealed traits, on a tree of
~500 tips we calculated the computation time using either the cla or the
standard likelihood. Loading and reloading different versions of the
same package inevitably requires restarting R in between to clear cache
memory and avoid using parts of code not completely unloaded. Hence,
here we do not actually perform the benchmark, but load the results
directly from file:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"timing_data.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">timing_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">version</span>, y <span class="op">=</span> <span class="va">time</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">num_threads</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_boxplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"secsse version"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Computation time (seconds)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"Number of\nthreads"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_brewer</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"qual"</span>, palette <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">type</span><span class="op">)</span></span></code></pre></div>
<p><img src="secsse_performance_files/figure-html/plot_results-1.png" class="r-plt" width="672"></p>
<p>It is clear that we have come a long way since 2019, and that current
versions of secsse are approximately a factor 100 faster. Note that for
the cla likelihood, there are not timings available for version 1.0.0,
because that version did not contain the cla likelihood versions
yet.</p>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<div class="section level3">
<h3 id="testing-code-standard-likelihood">Testing code standard likelihood<a class="anchor" aria-label="anchor" href="#testing-code-standard-likelihood"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">DDD</span><span class="fu">::</span><span class="fu"><a href="https://rsetienne.github.io/DDD/reference/dd_sim.html" class="external-link">dd_sim</a></span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">1000</span><span class="op">)</span>, age <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">tes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"this tree has: "</span>, <span class="va">phy</span><span class="op">$</span><span class="va">Nnode</span> <span class="op">+</span> <span class="fl">1</span>, <span class="st">" tips\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">traits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/summary.phylo.html" class="external-link">Ntip</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.04</span>, <span class="fl">0.04</span><span class="op">)</span>  <span class="co"># lambda</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">userTransRate</span> <span class="op">&lt;-</span> <span class="fl">0.2</span> <span class="co"># transition rate among trait states</span></span>
<span><span class="va">num_concealed_states</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">sampling_fraction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">toCheck</span> <span class="op">&lt;-</span> <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/id_paramPos.html">id_paramPos</a></span><span class="op">(</span><span class="va">traits</span>,<span class="va">num_concealed_states</span><span class="op">)</span></span>
<span><span class="va">toCheck</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">b</span></span>
<span><span class="va">toCheck</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">d</span></span>
<span><span class="va">toCheck</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">userTransRate</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">toCheck</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">root_state_weight</span> <span class="op">&lt;-</span> <span class="st">"proper_weights"</span></span>
<span><span class="va">use_fortran</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="va">methode</span> <span class="op">&lt;-</span> <span class="st">"odeint::runge_kutta_cash_karp54"</span></span>
<span><span class="va">cond</span> <span class="op">&lt;-</span> <span class="st">"noCondit"</span></span>
<span></span>
<span><span class="co"># the different secsse versions have similar, but not identical </span></span>
<span><span class="co"># syntax (mainly, they handle multi-threading / parallelization different)</span></span>
<span><span class="va">run_secsse_new</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">nt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/secsse_loglik.html">secsse_loglik</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="va">toCheck</span>,</span>
<span>                        phy <span class="op">=</span> <span class="va">phy</span>,</span>
<span>                        traits <span class="op">=</span> <span class="va">traits</span>,</span>
<span>                        num_concealed_states <span class="op">=</span> <span class="va">num_concealed_states</span>,</span>
<span>                        cond <span class="op">=</span> <span class="va">cond</span>,</span>
<span>                        root_state_weight <span class="op">=</span> <span class="va">root_state_weight</span>,</span>
<span>                        sampling_fraction <span class="op">=</span> <span class="va">sampling_fraction</span>,</span>
<span>                        num_threads <span class="op">=</span> <span class="va">nt</span>,</span>
<span>                        is_complete_tree <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">run_secsse_old</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">use_parallel</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/secsse_loglik.html">secsse_loglik</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="va">toCheck</span>,</span>
<span>                        phy <span class="op">=</span> <span class="va">phy</span>,</span>
<span>                        traits <span class="op">=</span> <span class="va">traits</span>,</span>
<span>                        num_concealed_states <span class="op">=</span> </span>
<span>                          <span class="va">num_concealed_states</span>,</span>
<span>                        sampling_fraction <span class="op">=</span> <span class="va">sampling_fraction</span>,</span>
<span>                        run_parallel <span class="op">=</span> <span class="va">use_parallel</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">measure_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">local_fun</span>, <span class="va">num_repl</span>, <span class="va">parallel</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">vv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_repl</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu">local_fun</span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span>    <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">vv</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">t1</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">vv</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_old</span>, <span class="fl">10</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_old</span>, <span class="fl">10</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">to_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t1</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">to_add2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t2</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">timing_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">timing_data</span>, <span class="va">to_add</span>, <span class="va">to_add2</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_new</span>, <span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_new</span>, <span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">t3</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_new</span>, <span class="fl">10</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="va">to_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t1</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">to_add2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t2</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">to_add3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t3</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="va">timing_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">timing_data</span>, <span class="va">to_add</span>, <span class="va">to_add2</span>, <span class="va">to_add3</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="testing-code-cla-likelihood">Testing code Cla likelihood<a class="anchor" aria-label="anchor" href="#testing-code-cla-likelihood"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">DDD</span><span class="fu">::</span><span class="fu"><a href="https://rsetienne.github.io/DDD/reference/dd_sim.html" class="external-link">dd_sim</a></span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span> , <span class="fl">0.3</span>, <span class="fl">1000</span><span class="op">)</span>, age <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">tes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"this tree has: "</span>, <span class="va">phy</span><span class="op">$</span><span class="va">Nnode</span> <span class="op">+</span> <span class="fl">1</span>, <span class="st">" tips and "</span>, <span class="va">phy</span><span class="op">$</span><span class="va">Nnode</span>, <span class="st">" internal nodes\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">num_concealed_states</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span></span>
<span><span class="va">traits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/summary.phylo.html" class="external-link">Ntip</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span>,replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sampling_fraction</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">idparlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cla_id_paramPos.html">cla_id_paramPos</a></span><span class="op">(</span><span class="va">traits</span>, <span class="va">num_concealed_states</span><span class="op">)</span></span>
<span><span class="va">lambda_and_modeSpe</span> <span class="op">&lt;-</span> <span class="va">idparlist</span><span class="op">$</span><span class="va">lambdas</span></span>
<span><span class="va">lambda_and_modeSpe</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.4</span>, <span class="fl">0.4</span>, <span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="va">parameter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">parameter</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_full_lambdas.html">prepare_full_lambdas</a></span><span class="op">(</span><span class="va">traits</span>, <span class="va">num_concealed_states</span>,</span>
<span>                                       <span class="va">lambda_and_modeSpe</span><span class="op">)</span></span>
<span></span>
<span><span class="va">parameter</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">9</span><span class="op">)</span></span>
<span></span>
<span><span class="va">masterBlock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.07</span>, ncol <span class="op">=</span> <span class="fl">3</span>, nrow <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">masterBlock</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">parameter</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/q_doubletrans.html">q_doubletrans</a></span><span class="op">(</span><span class="va">traits</span>, <span class="va">masterBlock</span>, diff.conceal <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">run_secsse_new</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">nt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/cla_secsse_loglik.html">cla_secsse_loglik</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="va">parameter</span>,</span>
<span>                            phy <span class="op">=</span> <span class="va">phy</span>,</span>
<span>                            traits <span class="op">=</span> <span class="va">traits</span>,</span>
<span>                            num_concealed_states <span class="op">=</span> <span class="va">num_concealed_states</span>,</span>
<span>                            sampling_fraction <span class="op">=</span> <span class="va">sampling_fraction</span>,</span>
<span>                            is_complete_tree <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                            num_threads <span class="op">=</span> <span class="va">nt</span>,</span>
<span>                            atol <span class="op">=</span> <span class="fl">1e-8</span>,</span>
<span>                            rtol <span class="op">=</span> <span class="fl">1e-6</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">run_secsse_old</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">use_parallel</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">secsse</span><span class="fu">::</span><span class="fu"><a href="../reference/cla_secsse_loglik.html">cla_secsse_loglik</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="va">parameter</span>,</span>
<span>                            phy <span class="op">=</span> <span class="va">phy</span>,</span>
<span>                            traits <span class="op">=</span> <span class="va">traits</span>,</span>
<span>                            num_concealed_states <span class="op">=</span> </span>
<span>                              <span class="va">num_concealed_states</span>,</span>
<span>                            sampling_fraction <span class="op">=</span> <span class="va">sampling_fraction</span>,</span>
<span>                            run_parallel <span class="op">=</span> <span class="va">use_parallel</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">measure_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">local_fun</span>, <span class="va">num_repl</span>, <span class="va">parallel</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">vv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_repl</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu">local_fun</span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span>    <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">vv</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">t1</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">vv</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_old</span>, <span class="fl">10</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_old</span>, <span class="fl">10</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">to_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t1</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">to_add2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t2</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">timing_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">timing_data</span>, <span class="va">to_add</span>, <span class="va">to_add2</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_new</span>, <span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_new</span>, <span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">t3</span> <span class="op">&lt;-</span> <span class="fu">measure_time</span><span class="op">(</span><span class="va">run_secsse_new</span>, <span class="fl">10</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="va">to_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t1</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">to_add2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t2</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">to_add3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">t3</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"secsse"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="va">timing_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">timing_data</span>, <span class="va">to_add</span>, <span class="va">to_add2</span>, <span class="va">to_add3</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Leonel Herrera Alsina, Paul van Els, Rampal S. Etienne.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
